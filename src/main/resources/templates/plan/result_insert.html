<!DOCTYPE html>
<html lang="en" dir="ltr"
	xmlns:th="http://www.thymeleaf.org">
<head>
<title></title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">

<!-- 공통 헤더 -->
<th:block th:include="/../fragments/header.html"></th:block>
<link rel="stylesheet" href="/../assets/vendor_assets/css/plan-result.css">

</head>
<body class="layout-light top-menu overlayScroll">
     
	<div class="mobile-search"></div>
	
	<div class="mobile-author-actions"></div>
	
	<!-- 공통 topbar -->
	<th:block th:include="/../fragments/topbar.html"></th:block>
	
	<main class="main-content" style="background-color: #F9FBFD;">
		
		<div class="contents" style="background-color: #F9FBFD;">
			
			<div class="container-fluid">
                
    <div class="wrapper clearfix">
    	<div class="row"> <!-- section 위에 -->
	        <div class="col-lg-12">
	        	<div class="breadcrumb-main">
	        		<h4 class="text-capitalize breadcrumb-title">결과입력</h4>
	        		<span class="ml-20 mt-1">재배관리-결과입력</span>
	        	</div>
	        	<div id="qrcode" style="display: none;"></div>
	        	<button type="button" id="qrBtn">QR출력</button>
	        </div>
       </div>
        <section id="section">
            <div class="step" id="step1">
                <div class="step_inner clearfix" id="step1_inner">
                    <div class="title">
                        <h3>구획정보<span></span></h3>
                    </div>
                    <div class="content clearfix">
                        <div class="left_content step4-container" id="segment_list" style="height:500px !important; overflow-y:auto !important;">
                           
                        </div>
                        <div class="right_content">
                            <div class="img_inner">
                                <div class="background-wrap">
                                    <ul id="step4-segment">
                                        
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="bottom_right-content clearfix"> <!-- 2021-11-01 추가  -->
                        	<div class="left_type">
                        		<span>개채수<span class="red">*</span></span>
	                            <input type="text" value="3" id="rowNum">
	                            <button type="button" onclick="addRow()">확인</button>
                        	</div>
                        	<div class="right_type">
                        		<div class="right_type_cover">
                        			<select id="segment_option">
                        				
	                        		</select>
	                        		<button type="button">확인</button>
                        		</div>
                        	</div>
                        </div>
                        <div class="bottom_content">
                            <div class="title clearfix" style="padding: 20px 0;">
		                        <h3 style="float: left;">결과입력 : A1-B1-C1-1</h3>
		                    </div>
                            <table id="step1_table" style="width: max-content;">
                                
                            </table>
                        </div>
                        <div class="submit_btn" style="padding: 10px">
                            <button class="type1">저장</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="step" id="step2">
                <div class="step_inner clearfix" id="step2_inner">
                    <div class="title">
                        <h3>구획정보확인<span></span></h3>
                    </div>
                    <div class="content clearfix">
                        <div class="content-center">
                            <div class="content_box">
	                            <div class="bottom_right-content clearfix"> <!-- 2021-11-01 추가  -->
			                      	<div class="left_type" style="width:60%;">
			                      		<span>기준개채수<span class="red">*</span></span>
			                           	<input type="text" id="segment_num" value="10">
			                           	<button type="button" onclick="checkSegment();">확인</button>
			                      	</div>
			                    </div>
                                <ul class="sangtaeLi clearfix">
                                    <li id="sangtae_list">
                                        <span class="sub_title-content regular_text"><i class="bi bi-arrows-move"></i>A1-B1-C1-1</span>
                                        <!-- <ul class="clearfix sangtae">
                                            <li><a href="#"><img src="../img/icons/green.png" alt="green"></a>
                                                <div class="lines">
                                                    <select>
                                                        <option>상태선택</option>
                                                        <option>상태선택</option>
                                                        <option>상태선택</option>
                                                        <option>상태선택</option>
                                                        <option>상태선택</option>
                                                        <option>상태선택</option>
                                                    </select>
                                                </div>
                                            </li>
                                            <li class="red"><a href="#"><img src="../img/icons/red.png" alt="red"></a>
                                                <div class="lines">
                                                    <select>
                                                        <option>상태선택</option>
                                                        <option>상태선택</option>
                                                        <option>상태선택</option>
                                                        <option>상태선택</option>
                                                        <option>상태선택</option>
                                                        <option>상태선택</option>
                                                    </select>
                                                </div>
                                            </li>
                                            <li><a href="#"><img src="../img/icons/green.png" alt="green"></a>
                                                <div class="lines">
                                                    <select>
                                                        <option>상태선택</option>
                                                        <option>상태선택</option>
                                                        <option>상태선택</option>
                                                        <option>상태선택</option>
                                                        <option>상태선택</option>
                                                        <option>상태선택</option>
                                                    </select>
                                                </div>
                                            </li>
                                        </ul> -->
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="submit_btn">
                            <button class="type1">저장</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="step" id="step3">
                <div class="step_inner clearfix" id="step3_inner">
                    <div class="title">
                        <h3>토양/기상 정보<span></span></h3>
                    </div>
                    <div class="content clearfix">
                        <div class="content-center">
                            <div class="content_box">
                                <span class="sub_title-content bold_text">토양정보(수동조회)</span>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>산도(ph)</th>
                                            <th>유효인산(mg/kg)</th>
                                            <th>유효규산(mg/kg)</th>
                                            <th>유기물(g/kg)</th>
                                            <th>마그네슘(cmol+/kg)</th>
                                            <th>칼륨(cmol+/kg)</th>
                                            <th>칼슘(cmol+/kg)</th>
                                            <th>전기전도도(dS/m)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>6.6</td>
                                            <td>28</td>
                                            <td>1</td>
                                            <td>1</td>
                                            <td>1</td>
                                            <td>1</td>
                                            <td>1</td>
                                            <td>1</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="content_box">
                                <span class="sub_title-content bold_text">토양정보(수동조회)</span>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>강수량</th>
                                            <th>증발량</th>
                                            <th>풍속(150CM)</th>
                                            <th>풍속(300CM)</th>
                                            <th>결로시간</th>
                                            <th>초상온도</th>
                                            <th>습도(150CM)</th>
                                            <th>습도(400CM)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>0.0mm</td>
                                            <td>Xmm</td>
                                            <td>3.0</td>
                                            <td>3.0</td>
                                            <td>0.0hr</td>
                                            <td>-3.2℃</td>
                                            <td>26.4%</td>
                                            <td>26.4%</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="submit_btn">
                            <button class="type1">저장</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <div class="row mt-4">
			<div class="col-lg-12">
				<div class="card card-default">
					<div class="row ml-3 mt-3">
						<span class="color-dark align-center" style="font-size: 20px;">변경 이력</span>
					</div>
					<div class="card-body" style="height: 325px; overflow-y: auto;">
						<div class="row">
							<div class="col-lg-12" style="padding-left: 15px;">
								<ul>
									<th:block th:each="r : ${record}">
										<li class="mt-2">
											<span class="avatar avatar-success avatar-md avatar-circle" style="float: left;">
                                                   <span class="avatar-icon" data-feather="check"></span>
                                               </span>
											<div>
												<span class="font-weight-bold mb-0">생육조사계획 : </span>
												<span class="font-weight-bold mb-0" th:text="${r.record_type_code}"></span>
												<th:block th:switch="${r.record_status}">
													<span th:case="0" class="font-weight-bold mb-0">승인요청</span>
													<span th:case="1" class="font-weight-bold mb-0">수정요청</span>
													<span th:case="2" class="font-weight-bold mb-0">승인</span>
												</th:block>
											</div>
											<small th:text="${r.record_date}"></small>
										</li>
									</th:block>
								</ul>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
    </div>
</div>
			
		</div>
        <div class="modal-basic modal fade show" id="chanModal2" tabindex="-1" role="dialog" aria-hidden="true" style="display: none">
		    <div class="modal-dialog modal-lg" role="document">
		        <div class="modal-content modal-bg-white">
		            <div class="modal-body">
		            	<div class="row">
			        		<div class="col-12">
			        			<h2 style="float: left;">측정 값</h2>
					        	<div class="d-flex justify-content-end">
			                		<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span data-feather="x"></span></button>
			                	</div>
			        		</div>
			        	</div>
		            	<div class="row mt-3">
		            		<div class="col-md-12">
		            			<table>
                                    <thead>
                                    <tr>
                                        <th>일시</th>
                                        <th>색상</th>
                                        <th>기상정보</th>
                                        <th>토양정보</th>
                                        <th>위치정보</th>
                                        <th>사진</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                        <td>2021.08.06</td>
                                        <td>#FFFFCC</td>
                                        <td class="blue"><a href="">view</a></td>
                                        <td class="blue"><a href="">view</a></td>
                                        <td class="blue"><a href="">map</a></td>
                                        <td class="blue"><a href="">view</a></td>
                                    </tbody>
                                </table>
		            		</div>
		            	</div>
			            <div class="row" style="flex-direction:row-reverse; padding: 20px 17px;">
			            	<div class="submit_btn">
                                <ul>
                                    <li><button class="type2">사진 선택</button></li>
                                    <li><button class="type2">사진 선택</button></li>
                                </ul>
                            </div>
			            </div>
		            </div>
		        </div>
		    </div>
		</div>
	    <!-- ends: .modal-Basic -->
	</main>
	
	 <!-- 공통 하단 -->
    <th:block th:include="/../fragments/footer.html"></th:block>
    <!-- 공통 js -->
    <th:block th:include="/../fragments/commonjs.html"></th:block>
    <script type="text/javascript" src="/../assets/vendor_assets/js/plan-segment.js"></script>
    <script type="text/javascript" src="/../assets/vendor_assets/js/plan-render.js"></script>
    <script type="text/javascript" src="/../assets/vendor_assets/js/qrcode.min.js"></script>
    <script type="text/javascript" src="https://cdn.rawgit.com/eligrey/FileSaver.js/5ed507ef8aa53d8ecfea96d96bc7214cd2476fd2/FileSaver.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.5.0-beta4/html2canvas.js"></script>
    
<script type="text/javascript" th:inline="javascript">

	let plan = /*[[${plan}]]*/ "null";
	let factor = /*[[${factor}]]*/ "null";
	let method = /*[[${method}]]*/ "null";
	let user = /*[[${user}]]*/ "null";
	let sch = /*[[${sch}]]*/ "null";

	//시험구 배치 데이터
	let data1 = new Object();
	let data2 = new Object();
	let data3 = new Object();
	
	let manureArray = new Array();
	let manureArray1 = new Array();
	let manureArray2 = new Array();
	let manureArray3 = new Array();
	let etcArray = new Array();
	let etcArray1 = new Array();
	let etcArray2 = new Array();
	let etcArray3 = new Array();
	
	let factorArray = new Array();
	let resultArray = new Array();
	
	//구획정보 기존 데이터 만들기 함수
	async function loadPlan(){
		
		//기존 데이터 만들기
		for(var i = 0; i < factor.length; i++){
			if(factor[i].factor_type == "시험재료"){
				var seed_ids = factor[i].factor_seed.split(",");
				var idx = factor[i].factor_index;
				await loadSeedGrid(seed_ids, idx);
			}else if(factor[i].factor_type == "재식거리"){
				var texts = factor[i].factor_interval;
				var idx = factor[i].factor_index;
				loadIntervalGrid(texts, idx);
			}else if(factor[i].factor_type == "재식주수"){
				var texts = factor[i].factor_plants;
				var idx = factor[i].factor_index;
				loadPlantsGrid(texts, idx);
			}else if(factor[i].factor_type == "파종량"){
				var texts = factor[i].factor_amount;
				var idx = factor[i].factor_index;
				loadAmountGrid(texts, idx);
			}
			else if(factor[i].factor_type == "시비량"){
				var manure_ids = factor[i].manure_id;
				var idx = factor[i].factor_index;
				await loadManureGrid(manure_ids, idx);
			}else if(factor[i].factor_type == "기타"){
				var etc_ids = factor[i].etc_id;
				var idx = factor[i].factor_index;
				await loadEtcGrid(etc_ids, idx);
			}
		}//end for
		
		//구획정보 그리기 함수 실행
		gridFactors();
		
	}
	
	//기존 시험재료 선택 데이터 만들기
	function loadSeedGrid(seed_ids, idx){
		return new Promise(function(resolve){
			var report_code = plan.report_code;
			
			var data = {"report_code" : report_code};
			
			$.ajax({
				url : "/plan/selectSeed",
				method : "GET",
				dataType : 'json',
				data : data,
				success : function(result){
					
					var add_list = "";
					
					var grid_array = new Array();
					
					//기존 데이터와 맞는 seed를 grid_array에 담아주기
					for(var i = 0; i < seed_ids.length; i++){
						for(var j = 0; j < result.length; j++){
							if(result[j].seed_id == seed_ids[i]){
								grid_array.push(result[j]);
							}
						}
					}//end for
					
					//선택된 데이터 기준으로 text 및 data 만들어주기
					var index = idx;
					var type = "시험재료";
					var content = "";
					var text = "";
					
					var length = grid_array.length;
					
					for(var i = 0; i < grid_array.length; i++){
						if(i == (length-1)){
							content += grid_array[i].seed_id;
							text += grid_array[i].division + " " + "(" + grid_array[i].genetic + ")";
						}else{
							content += grid_array[i].seed_id+',';
							text += grid_array[i].division + " " + "(" + grid_array[i].genetic + ")" +",";
						}
					}
					
					if(index == 1){
						data1.type = type;
						data1.content = content;
						data1.text = text;
					}else if(index == 2){
						data2.type = type;
						data2.content = content;
						data2.text = text;
					}else if(index == 3){
						data3.type = type;
						data3.content = content;
						data3.text = text;
					}
					
					resolve("성공");
				}//end success
				
			});//end ajax
		});
	}//end 기존 시험재료 그리기
	
	//기존 재식거리 데이터 만들기
	function loadIntervalGrid(texts, idx){
		
		var index = idx;
		var type = "재식거리";
		var content = texts;
		var text = texts;
		
		if(index == 1){
			data1.type = type;
			data1.content = content;
		}else if(index == 2){
			data2.type = type;
			data2.content = content;
		}else if(index == 3){
			data3.type = type;
			data3.content = content;
		}
		
	}//end 기존 시험재료 그리기
	
	//기존 재식주수 데이터 만들기
	function loadPlantsGrid(texts, idx){
		
		//기존 재식주수 텍스트 붙여주기
		var index = idx;
		var type = "재식주수";
		var content = texts;
		var text = texts;
		
		if(index == 1){
			data1.type = type;
			data1.content = content;
		}else if(index == 2){
			data2.type = type;
			data2.content = content;
		}else if(index == 3){
			data3.type = type;
			data3.content = content;
		}
		
	}//end 기존 재식주수 데이터 만들기
	
	//기존 파종량 데이터 만들기
	function loadAmountGrid(texts, idx){
		
		//기존 파종량 텍스트 붙여주기
		var index = idx;
		var type = "파종량";
		var content = texts;
		var text = texts;
		
		if(index == 1){
			data1.type = type;
			data1.content = content;
		}else if(index == 2){
			data2.type = type;
			data2.content = content;
		}else if(index == 3){
			data3.type = type;
			data3.content = content;
		}
		
	}//end 기존 파종량 데이터 만들기
	
	//기존 시비량 데이터 만들기
	function loadManureGrid(manure_ids, idx){
		return new Promise(function(resolve){
			
			var index = idx;
			var type = "시비량";
			var text = "";
			
			var textArray = manure_ids.split(",");
			
			var plan_id = plan.plan_id;
			
			var data = {"plan_id" : plan_id};
			
			$.ajax({
				url : "/plan/selectManure",
				method : "GET",
				dataType : 'json',
				data : data,
				success : function(result){
					
					//기존 데이터에 맞게 manureArray 만들어 주기
					for(var i = 0; i < textArray.length; i++){
						for(var j = 0; j < result.length; j ++){
							if(textArray[i] == result[j].manure_id){
								var data = {
										"fert_id" : result[j].fert_id,
										"manure_area" : result[j].manure_area,
										"manure_ingredient" : result[j].manure_ingredient,
										"manure_type" : result[j].manure_type,
										"manure_amount" : result[j].manure_amount,
										"manure_result" : result[j].manure_result,
										"manure_level" : result[j].manure_level
								}
								manureArray.push(data);
							}
						}
					}//end for1
					
					//level 만들기
					var levels = "";
					var level = "";
					for(var i = 0; i < manureArray.length; i++){
						levels += manureArray[i].manure_level+",";
					}
					
					var levels_array = levels.slice(0, -1).split(",");
					var array_set = Array.from(new Set(levels_array));
					levels = "";
					for(var i = 0; i < array_set.length; i++){
						levels += "수준"+array_set[i]+"(시),";
					}
					
					level = levels.slice(0,-1);
					
					
					//text 만들기
					var level_length = array_set.length;
					for(var i = 0; i < level_length; i++){
						text += '수준' + (i+1) + " => ";
						for(var j = 0; j < manureArray.length; j++){
							if((i+1) == manureArray[j].manure_level){
								text += manureArray[j].manure_result+'kg/10a('+manureArray[j].manure_type+')'+'값(kg), ';
							}
						}
					}
					
					if(index == 1){
						data1.type = type;
						data1.content = level;
						for(var i = 0; i < manureArray.length; i++){
							manureArray1.push(manureArray[i]);
						}
						manureArray = [];
					}else if(index == 2){
						data2.type = type;
						data2.content = level;
						for(var i = 0; i < manureArray.length; i++){
							manureArray2.push(manureArray[i]);
						}
						manureArray = [];
					}else if(index == 3){
						data3.type = type;
						data3.content = level;
						for(var i = 0; i < manureArray.length; i++){
							manureArray3.push(manureArray[i]);
						}
						manureArray = [];
					}
					
					resolve("성공");
				}//end success
			});//end ajax
			
		});
	}//기존 시비량 데이터 만들기
	
	
	//기존 etc 데이터 만들기
	function loadEtcGrid(etc_ids, idx){
		return new Promise(function(resolve){
			var textArray = etc_ids.split(",");
			
			var data = {"plan_id" : plan.plan_id};
			
			$.ajax({
				url : "/plan/selectEtc",
				method : "GET",
				dataType : 'json',
				data : data,
				success : function(result){
					
					var index = idx;
					var type = "기타";
					var content = "";
					var text = "";
					
					//기존 데이터에 맞게 etcArray 만들어 주기
					for(var i = 0; i < textArray.length; i++){
						for(var j = 0; j < result.length; j ++){
							if(textArray[i] == result[j].etc_id){
								
								if(i == (textArray.length-1)){
									text += result[j].etc_value + '(' + result[j].etc_type + ')';
									content += result[j].etc_value + '(' + result[j].etc_type + ')';
								}else{
									text += result[j].etc_value + '(' + result[j].etc_type + '),';
									content += result[j].etc_value + '(' + result[j].etc_type + '),';
								}
								
								var data = {
										"etc_type" : result[j].etc_type,
										"etc_value" : result[j].etc_value,
										"etc_comment" : result[j].etc_comment
								}
								etcArray.push(data);
							}
						}
					}//end for1
					
					if(index == 1){
						data1.type = type;
						data1.content = content;
						for(var i = 0; i < etcArray.length; i++){
							etcArray1.push(etcArray[i]);
						}
						etcArray = [];
					}else if(index == 2){
						data2.type = type;
						data2.content = content;
						for(var i = 0; i < etcArray.length; i++){
							etcArray2.push(etcArray[i]);
						}
						etcArray = [];
					}else if(index == 3){
						data3.type = type;
						data3.content = content;
						for(var i = 0; i < etcArray.length; i++){
							etcArray3.push(etcArray[i]);
						}
						etcArray = [];
					}
					
					resolve("성공");
				}//end success
				
			});//end ajax
		});
	}//end function
	
	//기존 데이터 만드는 함수 실행
	loadPlan();
	
	//구획정보확인 셀렉트 박스 오픈 함수
	function loadSelectOption(){
		const contents = document.getElementsByClassName("sangtaeLi")[0],
        parentLi = contents.children;
		
		
	  for(let i=0; i<parentLi.length; i++){
		  let childeLi = parentLi[i].children[1].children;
		  
		  for(let k=0; k<childeLi.length; k++){
		      childeLi[k].idx = k;
		      
		      
		      childeLi[k].addEventListener("click", function(e){
		          e.preventDefault();
		          n=e.currentTarget.idx;
		          let select_line = childeLi[n].children[1];
		          for(let f=0; f<childeLi.length; f++){
		        	  let display = window.getComputedStyle(childeLi[f].children[1]).display;
		        	  childeLi[f].children[1].style.display="none";
		              childeLi[f].children[1].addEventListener("focusout", function(e){
		            	  if(display === "block"){
		            		  childeLi[f].children[1].style.display="none";
		            	  }
		              });
		          }
		          select_line.style.display="block";
		      });
		  }
		}
	}
	
	//구획정보 테이블 그리기
	function gridFactors(){
		
		//만들어준 데이터를 그려줄 부모 태그
		let segment_list = $("#segment_list");
		
		let factor1 = "";
		let factor2 = "";
		let factor3 = "";
		
		//데이터 null 여부에 따라 factor 만들기
		if(Object.keys(data1).length != 0){
			if(data1.type == "시험재료"){
				factor1 = data1.text.split(",");
			}else{
				factor1 = data1.content.split(",");
			}
		}
		if(Object.keys(data2).length != 0){
			if(data2.type == "시험재료"){
				factor2 = data2.text.split(",");
			}else{
				factor2 = data2.content.split(",");
			}
		}
		if(Object.keys(data3).length != 0){
			if(data3.type == "시험재료"){
				factor3 = data3.text.split(",");
			}else{
				factor3 = data3.content.split(",");
			}
		}
		
		//기존 재배계획의 반복 횟수
		let plan_repeat = plan.plan_repeat;
		
		//기존 재배계획의 시험구 배치 종류
		let gorw_type = plan.grow_type;
		
		//구획 id 만들기 위한 변수들
		let num = 0;
		let num1 = 0;
		let level = 0;
		let id = "";
		let id1 = "";
		let id2 = "";
		let type = "";
		let type2 = "";
		let type3 = "";
		let repeat = "";
		
		//factor null 유무에 따라 factorArray 만들어 주기
		if(factor1 != "" && factor2 == "" && factor3 == ""){
			for(var i = 0; i < factor1.length; i++){
				id = "A"+(i+1);
				type = factor1[i];
				num++;
				var number = num;
				
				var data = {"num" : number, "id" : id, "type" : type};
				factorArray.push(data);
				
				id = "";
				type = "";
			}
		}else if(factor1 != "" && factor2 != "" && factor3 == ""){
			for(var i = 0; i < factor1.length; i++){
				id = "A"+(i+1);
				type = factor1[i];
				
				for(var j = 0; j < factor2.length; j++){
					id2 = id;
					id2 = id2 + '-B' + (j+1);
					type2 = type;
					type2 = type2 + ',' + factor2[j];
					num++;
					var number = num;
					
					var data = {"num" : number, "id" : id2, "type" : type2};
					factorArray.push(data);
				}
				id = "";
				type = "";
			}
		}else if(factor1 != "" && factor2 != "" && factor3 != ""){
			for(var i = 0; i < factor1.length; i++){
				id = "A"+(i+1);
				type = factor1[i];
				
				for(var j = 0; j < factor2.length; j++){
					id2 = id;
					id2 = id2 + '-B' + (j+1);
					type2 = type;
					type2 = type2 + ',' + factor2[j];
					
					for(var k = 0; k < factor3.length; k++){
						num++;
						var number = num;
						id3 = id2;
						id3 = id3 + '-C'+(k+1);
						type3 = type2;
						type3 = type3 + ',' + factor3[k];
						
						var data = {"num" : number, "id" : id3, "type" : type3};
						factorArray.push(data);
					}//end for3
					
				}//end for2
				id = "";
				type = "";
			}//end for1
		}// end factor null 유무에 따라 factorArray 만들어 주기
		
		//만들어준 factorArray를 가지고 최종 resultArray 만들어 주기
		for(var i = 0; i < plan_repeat; i++){
			level++;
			for(var j = 0; j < factorArray.length; j++){
				num1++;
				var number = num1;
				var data = {"num" : number, "id" : factorArray[j].id+"-"+level, "type" : factorArray[j].type, "repeat" : i+1};
				
				resultArray.push(data);
			}
		}//end for
		
		
		//시험구 배치 종류에 따라 분기 처리
		if(gorw_type == "0"){	//완전임의배치
			
			//resultArray를 가지고 화면 그려주기
			var add_list = "";
			
			add_list += '<div class="box_content">';
			add_list += '<table style="width:max-content;">';
			add_list += '<thead>';
			add_list += '<tr>';
			add_list += '<th>구획번호</th>';
			add_list += '<th>구획ID</th>';
			add_list += '<th>처리종류</th>';
			add_list += '<th>반복</th>';
			add_list += '</tr>';
			add_list += '</thead>';
			add_list += '<tbody>';
			
			for(var i = 0; i < resultArray.length; i++){
				add_list += '<tr class="table_content">';
			    add_list += '<td class="table_num">'+resultArray[i].num+'</td>';
			    add_list += '<td>'+resultArray[i].id+'</td>';
			    add_list += '<td>'+resultArray[i].type+'</td>';
			    add_list += '<td>'+resultArray[i].repeat+'</td>';
			    add_list += '</tr>';
			}
			add_list += '</tbody>';
			add_list += '</table>';
			add_list += '</div>';
			
			segment_list.append(add_list);
		}else if(gorw_type == "1"){	//난괴법
			
			//resultArray를 가지고 화면 그려주기
			var add_list = "";
			var result_add_list = "";
			
			for(var i = 0; i < plan_repeat; i++){
				
				add_list += '<div class="box_content">';
				add_list += '<span class="sub_title-content">집구'+(i+1)+'</span>'
				add_list += '<table style="width:max-content;">';
				add_list += '<thead>';
				add_list += '<tr>';
				add_list += '<th>구획번호</th>';
				add_list += '<th>구획ID</th>';
				add_list += '<th>처리종류</th>';
				add_list += '<th>반복</th>';
				add_list += '</tr>';
				add_list += '</thead>';
				add_list += '<tbody>';
				
				for(var j = 0; j < resultArray.length; j++){
					
					if(resultArray[j].repeat == (i+1)){
						add_list += '<tr class="table_content">';
					    add_list += '<td class="table_num">'+resultArray[j].num+'</td>';
					    add_list += '<td>'+resultArray[j].id+'</td>';
					    add_list += '<td>'+resultArray[j].type+'</td>';
					    add_list += '<td>'+resultArray[j].repeat+'</td>';
					    add_list += '</tr>';
					}
				}//end for2
				
				add_list += '</tbody>';
				add_list += '</table>';
				add_list += '</div>';
				
				result_add_list += add_list;
				
				add_list = "";
			}//end for1
			
			segment_list.append(result_add_list);
			
		}
		
		//이곳에서 데이터 받아와야함 : important
		var getDataArr = [...resultArray];
		getDataResult(getDataArr);
		
	}//end gridFactors
	
	//구획정보 select 박스 그리기
	function gridSegmentSelect(){
		//select important
		segment_option = $("#segment_option");
		
		var add_list = "";
		
		for(var i = 0; i < resultArray.length; i++){
			add_list += '<option value="' + i + '">'+resultArray[i].id+'('+resultArray[i].type+'/'+resultArray[i].repeat+')'+'</option>';
		}
		
		segment_option.append(add_list);
		
	}//end 구획정보  select 박스 그리기
	
	gridSegmentSelect();
	selectBoxEl = document.querySelector('#segment_option');
	
	//결과입력 테이블 그리기
	function methodTableGrid(){
		console.log(method);
		let step1_table = $("#step1_table");
		
		var length = $("#rowNum").val();
		
		var add_list = "";
		
		add_list += '<thead>';
		add_list += '<tr>';
		add_list += '<th>개체</th>';
		//method important
		for(var i = 0; i < method.length; i++){
			add_list += '<th>'+method[i].method_title+'</th>';
		}
		
		add_list += '<tr>';
		add_list += '</thead>';
		
		add_list += '<tbody class="result_list">';
		
		for(var i = 0; i < length; i++){
			add_list += '<tr class="result_tr">';
			add_list += '<td class="td_num">'+(i+1)+'</td>';
			for(var j = 0; j < method.length; j++){
				add_list += '<td><input type="text" style="width: 90%;">';
				add_list += '<div class="cam">';
				add_list += '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-camera-fill" viewBox="0 0 16 16">';
				add_list += '<path d="M10.5 8.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/>';
				add_list += '<path d="M2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-1.172a2 2 0 0 1-1.414-.586l-.828-.828A2 2 0 0 0 9.172 2H6.828a2 2 0 0 0-1.414.586l-.828.828A2 2 0 0 1 3.172 4H2zm.5 2a.5.5 0 1 1 0-1 .5.5 0 0 1 0 1zm9 2.5a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0z"/>';
				add_list += '</svg>';
				add_list += '</div>';
				add_list == '</td>';
			}
			add_list += '</tr>';
		}
		
		add_list += '</tbody>';
		
		step1_table.append(add_list);
		
		checkSegment();
		
	}//end 결과입력 테이블 그리기
	
	//결과입력 테이블 그리기 실행 함수
	methodTableGrid();
	
	//개체수 그리기 함수
	function addRow(){
		
		let result_list = $(document).find(".result_list");
		
		//현재 결과입력 개체 row 길이
		let result_tr_length = $(document).find(".result_list").children().length;
		
		//입력한 개체수
		var rowNum = $("#rowNum").val();
		
		//현재 결과입력 개체의 마지막 번호
		let td_num = $(document).find(".result_list").children(":last").find(".td_num").text();
		
		var add_list = "";
		
		if(rowNum > result_tr_length){
			
			var length = rowNum - result_tr_length;
			var length1 = method.length;
			
			for(var i = 0; i < length; i++){
				td_num++;
				add_list += '<tr class="result_tr">';
				add_list += '<td class="td_num">'+td_num+'</td>';
				for(var j = 0; j < length1; j++){
					add_list += '<td><input type="text" style="width: 90%;">';
					add_list += '<div class="cam">';
					add_list += '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-camera-fill" viewBox="0 0 16 16">';
					add_list += '<path d="M10.5 8.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/>';
					add_list += '<path d="M2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-1.172a2 2 0 0 1-1.414-.586l-.828-.828A2 2 0 0 0 9.172 2H6.828a2 2 0 0 0-1.414.586l-.828.828A2 2 0 0 1 3.172 4H2zm.5 2a.5.5 0 1 1 0-1 .5.5 0 0 1 0 1zm9 2.5a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0z"/>';
					add_list += '</svg>';
					add_list += '</div>';
					add_list += '</td>';
				}
				add_list += '</tr>';
			}
			
			result_list.append(add_list);
			
			checkSegment();
			
		}else if(rowNum < result_tr_length){
			
			$(document).find(".result_tr").each(function(i, item){
				if(i > (rowNum-1)){
					$(this).remove();
				}
			});
			
			
			checkSegment();
		}//end else if
		
		
		
	}//end 개체수 그리기 함수
	
	//구획정보 확인 그리기
	function checkSegment(){
		
		//붙여줄 부모 태그
		let sangtae_list = $("#sangtae_list");
		$(".sangtae").remove();
		
		//입력한 개체수
		var rowNum = parseInt($("#rowNum").val());
		
		//기준 개체수
		var segment_num = parseInt($("#segment_num").val());
		
		
		var add_list = "";
		
		if(rowNum <= segment_num){
			
			add_list += '<ul class="clearfix sangtae">';
			
			for(var i = 0; i < rowNum; i++){
				add_list += '<li><a href="javascript:void(0);"><img class="sangtae_img" src="../img/icons/green.png" alt="green"></a>';
				add_list += '<div class="lines">';
				add_list += '<select class="select_option">';
				add_list += '<option value="none">상태선택</option>';
				add_list += '<option class="s_red" value="red">상태1</option>';
				add_list += '<option class="s_blue" value="blue">상태2</option>';
				add_list += '<option class="s_yellow" value="yellow">상태3</option>';
				add_list += '<option class="s_black" value="black">상태4</option>';
				add_list += '<option class="s_purple" value="purple">상태5</option>';
				add_list += '</select>';
				add_list += '</div>';
				add_list += '</li>';
				
			}
			add_list += '</ul>';
			
			sangtae_list.append(add_list);
			
		}else {
			
			var length1 = parseInt(rowNum / segment_num);
			var length2 = parseInt(rowNum % segment_num);
			
			for(var i = 0; i < length1; i++){
				add_list += '<ul class="clearfix sangtae">';
				for(var j = 0; j < segment_num; j++){
					add_list += '<li><a href="javascript:void(0);"><img class="sangtae_img" src="../img/icons/green.png" alt="green"></a>';
					add_list += '<div class="lines">';
					add_list += '<select class="select_option">';
					add_list += '<option value="none">상태선택</option>';
					add_list += '<option class="s_red" value="red">상태1</option>';
					add_list += '<option class="s_blue" value="blue">상태2</option>';
					add_list += '<option class="s_yellow" value="yellow">상태3</option>';
					add_list += '<option class="s_black" value="black">상태4</option>';
					add_list += '<option class="s_purple" value="purple">상태5</option>';
					add_list += '</select>';
					add_list += '</div>';
					add_list += '</li>';
				}
				add_list += '</ul>';
			}
			
			add_list += '<ul class="clearfix sangtae">';
			for(var i = 0; i < length2; i++){
				add_list += '<li><a href="javascript:void(0);"><img class="sangtae_img" src="../img/icons/green.png" alt="green"></a>';
				add_list += '<div class="lines">';
				add_list += '<select class="select_option">';
				add_list += '<option value="none">상태선택</option>';
				add_list += '<option class="s_red" value="red">상태1</option>';
				add_list += '<option class="s_blue" value="blue">상태2</option>';
				add_list += '<option class="s_yellow" value="yellow">상태3</option>';
				add_list += '<option class="s_black" value="black">상태4</option>';
				add_list += '<option class="s_purple" value="purple">상태5</option>';
				add_list += '</select>';
				add_list += '</div>';
				add_list += '</li>';
			}
			add_list += '</ul>';
			
			sangtae_list.append(add_list);
			
			
		}//end else
		/*loadSelectOption();*/
		$(".sangtae li").click(function(e){
			e.preventDefault();
			$(".sangtae li .lines").css({"display": "none"});
			$(this).children().eq(1).css({"display": "block"});
			
			$(this).children().eq(1).focusout(function(e){
				$(".sangtae li .lines").css({"display": "none"});
			});
		});
		
		
		
	}//구획정보 확인 그리기
	
	//구획정보 상태 선택 이벤트
	$(document).on("change", ".select_option", function(){
		
		var color = $(this).find("option:selected").val();
		
		var li = $(this).parent().parent();
		if(color == "red"){
			li.removeClass('red blue yellow black purple');
			li.addClass("red");
			$(this).parent().parent().find(".sangtae_img").attr("src", "../img/icons/red.png");
		}else if(color == "blue"){
			li.removeClass('red blue yellow black purple');
			li.addClass("blue");
			$(this).parent().parent().find(".sangtae_img").attr("src", "../img/icons/blue.png");
		}else if(color == "yellow"){
			li.removeClass('red blue yellow black purple');
			li.addClass("yellow");
			$(this).parent().parent().find(".sangtae_img").attr("src", "../img/icons/yellow.png");
		}else if(color == "black"){
			li.removeClass('red blue yellow black purple');
			li.addClass("black");
			$(this).parent().parent().find(".sangtae_img").attr("src", "../img/icons/black.png");
		}else if(color == "purple"){
			li.removeClass('red blue yellow black purple');
			li.addClass("purple");
			$(this).parent().parent().find(".sangtae_img").attr("src", "../img/icons/purple.png");
		}
		
	});
	
	//qr important
	function createQrcode(){
		var url = window.location.href;
		/* var url = "/plan/insertResult?plan_id="+plan.plan_id; */
		
		var qrcode = new QRCode(document.getElementById("qrcode"), {
			width : 100,
			height : 100
		});
		
		qrcode.makeCode(url);
	}
	
	createQrcode();
	
	$("#qrBtn").on("click", function(){
		downloadURI('qrCode');
	});
	
	function downloadURI(name){
		var canvas = document.querySelector('#qrcode canvas');
		var link = document.createElement("a");
		link.download = name;
		link.href = canvas.toDataURL("image/png");
		document.body.appendChild(link);
		link.click();
		link.delete;
	}

</script>
     
<script>
	window.addEventListener("load", function(){ //javascript
	    let section = document.getElementById("section"),
	    step = section.children,  
	    n = 0;
	    
	    
	    let slideUp = (title, target, duration=500) => {
	        title.classList.remove("active");
	        target.style.transitionProperty = 'height, margin, padding';
	        target.style.transitionDuration = duration + 'ms';
	        target.style.boxSizing = 'border-box';
	        target.style.height = target.offsetHeight + 'px';
	        target.offsetHeight;
	        target.style.overflow = 'hidden';
	        target.style.height = 0;
	        target.style.paddingTop = 0;
	        target.style.paddingBottom = 0;
	        target.style.marginTop = 0;
	        target.style.marginBottom = 0;
	        window.setTimeout( () => {
	            target.style.display = 'none';
	            target.style.removeProperty('height');
	            target.style.removeProperty('padding-top');
	            target.style.removeProperty('padding-bottom');
	            target.style.removeProperty('margin-top');
	            target.style.removeProperty('margin-bottom');
	            target.style.removeProperty('overflow');
	            target.style.removeProperty('transition-duration');
	            target.style.removeProperty('transition-property');
	        }, duration);
	    }
	    let slideDown = (title, target, duration=500) => {
	        target.style.removeProperty('display');
	        let display = window.getComputedStyle(target).display;
	        if (display === 'none')
	        display = 'block';
	        title.classList.add("active");
	        target.style.display = display;
	        let height = target.offsetHeight;
	        target.style.overflow = 'hidden';
	        target.style.height = 0;
	        target.style.paddingTop = 0;
	        target.style.paddingBottom = 0;
	        target.style.marginTop = 0;
	        target.style.marginBottom = 0;
	        target.offsetHeight;
	        target.style.boxSizing = 'border-box';
	        target.style.transitionProperty = "height, margin, padding";
	        target.style.transitionDuration = duration + 'ms';
	        target.style.height = height + 'px';
	        target.style.removeProperty('padding-top');
	        target.style.removeProperty('padding-bottom');
	        target.style.removeProperty('margin-top');
	        target.style.removeProperty('margin-bottom');
	        window.setTimeout( () => {
	            target.style.removeProperty('height');
	            target.style.removeProperty('overflow');
	            target.style.removeProperty('transition-duration');
	            target.style.removeProperty('transition-property');
	        }, duration);
	    }
	    let slideToggle = (title, target, duration = 500) => {
	        if (window.getComputedStyle(target).display === 'none') {
	            return slideDown(title, target, duration);
	        } else {
	            return slideUp(title, target, duration);
	        }
	    }
	    
	    for(let i=0; i<step.length; i++){
	        let stepInner = step[i].children;
	        for(let k=0; k<stepInner.length; k++){
	            let [title, content] = stepInner[k].children;
	            
	            title.addEventListener("click", function(e){
	                slideToggle(title, content);
	                const left_content = document.getElementsByClassName("left_content")[0],
	                      back = document.getElementsByClassName("background-content")[0];
	                let height = left_content.offsetHeight;
	                //??? 확인//back.style.height= height + "px";
	            });
	        }
	    }
	    //셀렉트박스 오픈 함수 실행
	    //loadSelectOption();
	    
	   /*  for(let i=0; i<parentLi.length; i++){
	        let childeLi = parentLi[i].children[1].children;
	        
	        for(let k=0; k<childeLi.length; k++){
	            childeLi[k].idx = k;
	            
	            
	            childeLi[k].addEventListener("click", function(e){
	                e.preventDefault();
	                n=e.currentTarget.idx;
	                let select_line = childeLi[n].children[1];
	                select_line.style.display="block";
	            });
	            childeLi[k].addEventListener("focusout", function(e){
	                let select_line = childeLi[n].children[1];
	                select_line.style.display="none";
	            });
	        }
	    } */
	          
	        
	//    const select_line = document.getElementsByClassName("line")[0],
	//          sangtae = document.getElementsByClassName("sangtae")[0];
	//    let flowList = sangtae.children;
	//    for(let i=0; i<flowList.length; i++){
	//        let mouseUp = flowList[i];
	//        
	//        let Move = Number(mouseUp.style.marginLeft.replace("px", ""));
	//        flowList[i].idx = i;
	//        flowList[i].addEventListener("focusin", function(e){
	//            e.preventDefault();
	//            n= e.currentTarget.idx;
	//            select_line[i].style.display= "block";
	//        });
	//        
	//        flowList[i].addEventListener("focusout", function(e){
	//            e.preventDefault();
	//            n= e.currentTarget.idx;
	//            select_line.style.display= "none";
	//        });
	//    }
	});
	
	
</script>
     
</body>    
</html>