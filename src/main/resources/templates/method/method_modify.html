<!doctype html>
<html lang="en" dir="ltr" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
<style>
	.content-header{margin-top:30px;}
	.end-button
	{
		width:126px;
   		height:47px;
		background-color:#768BF5;
		border:0px;
		margin-top:-15px;
	}
	.end{margin-left:10px;}
	.itemBoxHighlight { 
	border:solid 1px black; min-height: 80px; background-color:#768BF5; 
	}
	@media (min-width: 576px){
		.col-sm-10 {
		    -webkit-box-flex: 0;
		    -ms-flex: 0 0 80%;
		    flex: 0 0 80%;
		    max-width: 80%;
		}
		.col-sm-2 {
		    -webkit-box-flex: 0;
		    -ms-flex: 0 0 20%;
		    flex: 0 0 20%;
		    max-width: 20%;
		}
	}
	.top-menu .type_1{
		background-color: #768BF5;
		border-left: none;
		border-radius: 0 5px 5px 0;
	}
	#searchResearch{
		float: left;
	    width: 60%;
	   	border-radius: 5px 0 0 0;
	   	border-right: none;
	}
	#addResearchBtn{
		float:left;
		border-left:none;
		border-radius: 0 5px 0 0;
		height: 42px;
		margin-top: 0 !important;
		width: 40%;
		background-color:#768BF5;
		border-color: #768BF5;
		opacity:0.65;
	}
	.box_content{
	    -webkit-box-flex: 0;
	    -ms-flex: 0 0 66.66667%;
	    flex: 0 0 5%;
	    max-width: 5%;
	    display: flex;
	    justify-content: center;
	}
	.box_center li{
		margin-bottom: 20px;
	}
	.box_center li button{
		border-radius: 50%;
    	border: 2px solid #788DEE;
    	background-color: transparent;
    	height: 38px;
    	color: #788DEE;
	}
	.card-body .mt-4{
		margin-top: 10px !important;
	}
	@media (min-width: 992px){
		.card .col-lg-8 {
		    -webkit-box-flex: 0;
		    -ms-flex: 0 0 66.66667%;
		    flex: 0 0 70%;
		    max-width: 70%;
		}
		.card .col-lg-3 {
		    -webkit-box-flex: 0;
		    -ms-flex: 0 0 25%;
		    flex: 0 0 25%;
		    max-width: 25%;
		}
	}
	.contents .row{
		align-items:center;
	}
	
	.contents .mt-2, .contents .my-2{
		margin:0 !important;
		margin-top: 0 !important;
	}
	.list-group-item{
		width: 100%;
	    padding: 2px1.25rem;
	    font-size: 14px;
	}
	
	/*인쇄 설정 */
	@media print {
	 .noprint { display : none !important; }
	 @page {
	  size : portrait; /* 세로 설정 */
	  margin: 10px 10px 0px 10px;
	 }
	 /* html {
	  zoom : 40%;
	 } */
	}
	
	.select-hide{
		display: none;
	}
	.select-show{
		display: block;
	    position: absolute;
	    z-index :10;
	    top: 30px;
	    width: 97.5%;
	    background-color: white;
	    border:1px solid;
	    border-radius: 5px;
	    cursor: pointer;
	    overflow-y: auto;
	    height: 125px;
	}
	
	#divisionModal .select-show{
		display: block;
	    position: absolute;
	    z-index :10;
	    top: 60px;
	    width: 96%;
	    background-color: white;
	    border:1px solid;
	    border-radius: 5px;
	    cursor: pointer;
	    overflow-y: auto;
	    height: 125px;
	}

	.select .select-show li{
	    padding:0 0 0 5px;
	    line-height: 30px;
	}
	[id *="_popup"]{
		width:100vw; 
		height:90vh; 
		position:fixed; 
		left:0px; 
		top:0px; 
		display:none; 
		justify-content: center; 
		align-items:center; 
		z-index: 999999;
	}
	[id *="_popup"] > .card.card-default.card-md.mb-4{
		border:1px solid #eee;
		width:400px;
		max-width: 400px;
	}
	
</style>
<!-- 공통 헤더 -->
<th:block th:include="/../fragments/header.html"></th:block>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
</head>
<body class="layout-light top-menu overlayScroll">
	<div class="mobile-search"></div>
	<div class="mobile-author-actions"></div>
	<!-- 공통 topbar -->
	<th:block th:include="/../fragments/topbar.html"></th:block>
	<main class="main-content" style="background-color: #F9FBFD;">
		<div class="contents" style="background-color: #F9FBFD;">
		    <div class="container-fluid" id="printDiv" style="padding: 0 50px;">
		    	<div class="row">
			        <div class="col-lg-12" style="padding: 0 17px;">
			        	<div class="breadcrumb-main" style="float: left; padding:0;">
			        		<h4 class="text-capitalize breadcrumb-title">재배 프로토콜 수정</h4>
			        		<span class="ml-20 mt-1">프로토콜 - 재배 프로토콜 수정</span>
			        	</div>
			        </div>
		        </div>
		    	<div class="row">
			        <div class="col-lg-12">
			        	<div class="card">
			        		<div class="card-body" style="padding:35px 50px 30px">
		        				<div class="row">
		        					<div class="col-sm-2 d-flex aling-items-center">
		                            	<label for="input_title" class="col-form-label color-dark align-center">Method 명<span style="color: red;">*</span></label>
	                                </div>
	                                <div class="col-sm-10">
	                                   <input type="text" class="form-control" style="float: left; width: 90%; border-right:none; border-radius: 5px 0 0 5px" id="input_title" readonly>
	                                   <button class="btn btn-primary type_1 noprint" onclick="DivisionBtn();" style="height:34.13px;width: 10%;">항목 수정</button>
	                                </div>
		                         </div>
		                         <div class="row mt-3">
		        					<div class="col-sm-2 d-flex aling-items-center">
		                            	<label for="method_contents" class="color-dark align-center">Method 설명</label>
		                            </div>
		                            <div class="col-sm-10">
		                                <input type="text" class="form-control b-light" id="method_contents" th:value="${method.method_contents}">
		                            </div>
		                    	</div>
		                    	<div class="row mt-3">
		        					<div class="col-sm-2 d-flex aling-items-center">
		                            	<label for="method_input" class="color-dark align-center">입력 단위</label>
		                            </div>
		                            <div class="col-sm-5">
		                            	<div class="select" style="height: auto;">
		                            		<input type="text" onkeyup="textfilter(this);" onclick="selectFilter(this);" name="select-input" data-select="" class="form-control" id="method_input" placeholder="입력단위 선택" autocomplete="new-password">
		                            		<ul class="select-hide">
		                            			<li class="seed_method_list" onclick="selectOpt(this);"><span data-value="길이">길이</span></li>
		                            			<li class="seed_method_list" onclick="selectOpt(this);"><span data-value="넓이">넓이</span></li>
		                            			<li class="seed_method_list" onclick="selectOpt(this);"><span data-value="무게">무게</span></li>
		                            			<li class="seed_method_list" onclick="selectOpt(this);"><span data-value="부피">부피</span></li>
		                            			<li class="seed_method_list" onclick="selectOpt(this);"><span data-value="온도">온도</span></li>
		                            			<li class="seed_method_list" onclick="selectOpt(this);"><span data-value="압력">압력</span></li>
		                            			<li class="seed_method_list" onclick="selectOpt(this);"><span data-value="속도">속도</span></li>
		                            			<li class="seed_method_list" onclick="selectOpt(this);"><span data-value="회전수">회전수</span></li>
		                            			<li class="seed_method_list" onclick="selectOpt(this);"><span data-value="시간">시간</span></li>
		                            			<li class="seed_method_list" onclick="selectOpt(this);"><span data-value="기타">기타</span></li>
		                            		</ul>
		                            	</div>
		                                <!-- <select class="form-control b-light" id="method_input">
			                                <option value="">입력단위 선택</option>
			                                <option value="길이">길이</option>
			                                <option value="넓이">넓이</option>
			                                <option value="무게">무게</option>
			                                <option value="부피">부피</option>
			                                <option value="온도">온도</option>
			                                <option value="압력">압력</option>
			                                <option value="속도">속도</option>
			                                <option value="회전수">회전수</option>
			                                <option value="시간">시간</option>
			                                <option value="기타">기타</option>
		                                </select> -->
		                            </div>
		                            <div class="col-sm-5">
		                            	<div class="select" style="height: auto;">
		                            		<input type="text" onkeyup="textfilter(this);" onclick="selectFilter(this);" name="select-input" data-select="" class="form-control" id="method_eaches" placeholder="단위 종류 선택" autocomplete="new-password">
		                            		<ul class="select-hide">
		                            			
		                            		</ul>
		                            	</div>
		                            	<!-- <select class="form-control b-light" id="method_eaches">
			                                <option value="">단위 종류 선택</option>
		                                </select> -->
		                            </div>
		                    	</div>
		                    	<div class="row mt-3">
		        					<div class="col-sm-2 d-flex aling-items-center">
		                            	<label for="protocol" class="color-dark">Protocol</label>
		                            </div>
		                            <div class="col-sm-10">
		                                <textarea id="protocol" class="form-control" rows="10" readonly></textarea>
		                            </div>
		                    	</div>
		                    	<div class="row mt-3">
		        					<div class="col-sm-2 d-flex aling-items-center">
		                            	<label for="method_comment" class="color-dark">기타</label>
		                            </div>
		                            <div class="col-sm-10">
		                                <textarea id="method_comment" class="form-control b-light" rows="5" th:text="${method.method_comment}"></textarea>
		                            </div>
		                    	</div>
		                    	<div class="row mt-3">
			        				<div class="col-sm-2">
			        					
			        					<label for="method_share">
			        						<span class="color-dark" th:text="${#authentication.principal.d3_department_name} + | 공유|"></span>
			        					</label>
			        					<input type="checkbox" id="method_share" th:value="0">
			        				</div>
			        			</div>
			        		</div>
			        	</div>
			        </div>
		        </div>
		        
				<div class="row mt-20 noprint">
					<div class="col-lg-12">
						<div class="card">
							<div class="card-body" style="padding: 35px 50px 30px;"> 
								<div class="row">
									<div class="col-lg-12" style="padding: 0 0 21px 0">
										<span class="color-dark align-center" style="font-size: 18px !important;">Step 설정</span>
									</div>
								</div>
								<div class="row mt-4" style="justify-content: center;">
									<div class="col-lg-3">
										<div class="row">
											<input type="text" onkeyup="filter();" class="form-control b-light" id="searchResearch" placeholder="조사방법 검색" style="height: 40px;">
											<button id="addResearchBtn" class="btn btn-dark mt-2" onclick="InsertPopup();" style="height: 40px">조사방법 추가</button>
										</div>
										<div class="row" style="overflow:auto; height: 459.74px; border: 1px solid #D9D9D9; border-top: transparent">
											<div class="list-group mt-2" style="height: 100%; overflow-y: auto; width:100%;" id="research_list">
												
											</div>
										</div>
									</div>
									<div class="box_content">
										<div class="box_center">
											<ul>
												<li><button onclick="PlusResearch();"><span data-feather="plus"></span></button></li>
												<li><button onclick="MinusResearch();"><span data-feather="minus"></span></button></li>
											</ul>
										</div>
									</div>
									<div class="col-lg-8" style="padding:0;">
										<ul class="list-group" id="step-container" style="min-height: 500px; max-height: 500px;
											overflow-y: auto; background-color: rgb(243, 243, 243) ">
											
										</ul>
									</div>
								</div>
			        		</div>
			        	</div>
			        </div>
		        </div>
		        <div class="row noprint">
					<div class="col-4">
						<div class="action-btn d-flex justify-content-frist mt-30">
							<button type="button" class="btn btn-primary end-button" id="printBtn">인쇄</button>
							<th:block th:if="${#authentication.principal.user_type == 0 and method.method_status == 0 or method.method_status == 1}">
								<button type="button" class="btn btn-default btn-info end-button end" onclick="UpdateStatusBtn();">승인</button>
							</th:block>
						</div>
					</div>
					<div class="col-4">
						<div class="d-flex justify-content-center mt-30"></div>
					</div>
					<div class="col-4">
						<div class="action-btn d-flex justify-content-end mt-30">
							<a href="/method/list" class="btn btn-primary end-button end" style="background-color:#E2E3E5;">목록</a>
							<button type="button" class="btn btn-default btn-danger end-button end" onclick="DeleteBtn();">삭제</button>
		                	<button type="button" class="btn btn-default btn-primary end-button end" onclick="UpdateBtn();">수정</button>
						</div>
					</div>
				</div>
				<div class="row mt-4">
					<div class="col-lg-12">
						<div class="card card-default" style="padding: 0 30px;">
							<div class="row ml-3 mt-3" style="margin:0 !important; padding: 35px 20px 22px 20px">
								<span class="color-dark align-center" style="font-weight: 700; color: #2c2c2c">변경 이력</span>
							</div>
							<div class="card-body" style="height: 325px; overflow-y: auto; padding-left: 10px; padding-top:0;">
								<div class="row">
									<div class="col-lg-12">
										<ul>
											<th:block th:each="r : ${record}">
												<li style="margin-top: 10px !important">
													<span class="avatar avatar-success avatar-md avatar-circle" style="float: left;">
	                                                    <span class="avatar-icon" data-feather="check"></span>
	                                                </span>
													<div>
														<span class="font-weight-bold mb-0">Method ID : </span>
														<span class="font-weight-bold mb-0" th:text="${r.record_type_code}"></span>
														<th:block th:switch="${r.record_status}">
															<span th:case="0" class="font-weight-bold mb-0">승인요청</span>
															<span th:case="1" class="font-weight-bold mb-0">수정요청</span>
															<span th:case="2" class="font-weight-bold mb-0">승인</span>
														</th:block>
													</div>
													<small th:text="${r.record_date}"></small>
												</li>
											</th:block>
										</ul>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
		    </div>
		    
		    <div class="modal-basic modal fade show" id="divisionModal" tabindex="-1" role="dialog" aria-hidden="true">
			    <div class="modal-dialog modal-xl" role="document">
			        <div class="modal-content modal-bg-white">
			        	<div class="modal-header">
			        		<h6 class="modal-title">조사항목 조회</h6>
	                    	<button type="button" class="close" data-dismiss="modal" aria-label="Close">
	                        	<span data-feather="x"></span>
	                        </button>
			        	</div>
			            <div class="modal-body">
			            	<div class="col-12">
		        				<div class="row">
			        				<div class="col-md-6 mb-25">
	                                    <label for="division_depth1" class="color-dark fw-500">대상작목</label>
	                                    <div class="select" style="height: auto;">
		                            		<input type="text" onkeyup="textfilter(this);" onclick="selectFilter(this);" name="select-input" data-select="" class="form-control" id="division_depth1" placeholder="대상 작목 선택" autocomplete="new-password">
		                            		<ul class="select-hide">
		                            			<th:block th:each="d1 : ${d1}">
		                            				<li class="division_depth1_list" onclick="selectOpt(this);"><span th:data-value="${d1.division_id}" th:text="${d1.division}"></span></li>
		                            			</th:block>
		                            		</ul>
		                            	</div>
	                                    <!-- <select class="form-control b-light select" id="division_depth1" disabled="disabled">
			                                <th:block th:each="d1 : ${d1}">
				                                <option th:value="${d1.division_id}" th:text="${d1.division}" th:selected="${d1.division_id == method.d1_id}"></option>
			                                </th:block>
			                            </select> -->
	                                </div>
	                                <div class="col-md-6 mb-25">
	                                    <label for="division_depth2" class="color-dark fw-500">분류</label>
	                                    <div class="select" style="height: auto;">
		                            		<input type="text" onkeyup="textfilter(this);" onclick="selectFilter(this);" name="select-input" data-select="" class="form-control" id="division_depth2" placeholder="분류 선택" autocomplete="new-password">
		                            		<ul class="select-hide">
		                            			<th:block th:each="d2 : ${d2}">
		                            				<li class="division_depth2_list" onclick="selectOpt(this);"><span th:data-value="${d2.division_id}" th:text="${d2.division}"></span></li>
		                            			</th:block>
		                            		</ul>
		                            	</div>
	                                    <!-- <select class="form-control b-light select" id="division_depth2" disabled="disabled">
			                                <th:block th:each="d2 : ${d2}">
				                                <option th:value="${d2.division_id}" th:text="${d2.division}" th:selected="${d2.division_id == method.d2_id}"></option>
			                                </th:block>
			                            </select> -->
	                                </div>
	                            </div>
	                            <div class="row">
			        				<div class="col-md-6 mb-25">
	                                    <label for="division_depth3" class="color-dark fw-500">항목</label>
	                                    <div class="select" style="height: auto;">
		                            		<input type="text" onkeyup="textfilter(this);" onclick="selectFilter(this);" name="select-input" data-select="" class="form-control" id="division_depth3" placeholder="항목 선택" autocomplete="new-password">
		                            		<ul class="select-hide">
		                            			<th:block th:each="d3 : ${d3}">
		                            				<li class="division_depth3_list" onclick="selectOpt(this);"><span th:data-value="${d3.division_id}" th:text="${d3.division}"></span></li>
		                            			</th:block>
		                            		</ul>
		                            	</div>
	                                    <!-- <select class="form-control b-light select" id="division_depth3" disabled="disabled">
			                                <th:block th:each="d3 : ${d3}">
				                                <option th:value="${d3.division_id}" th:text="${d3.division}" th:selected="${d3.division_id == method.d3_id}"></option>
			                                </th:block>
			                            </select> -->
	                                </div>
	                                <div class="col-md-6 mb-25">
	                                    <label for="research_contents" class="color-dark fw-500">Method 명</label>
	                                    <input type="text" class="form-control b-deep" id="method_title" th:value="${method.method_title}">
	                                </div>
	                            </div>
			            		<div class="button-group d-flex justify-content-end">
				                   <button class="btn btn-primary btn-default btn-squared" id="titleBtn" onclick="TitleBtn();">사용</button>
				           		</div>
			            	</div>
			            </div>
			        </div>
			    </div>
			</div>

	        <div class="atbd-notice" id="success_popup">
	        	<div class="card card-default card-md mb-4">
	        		<div class="card-body">
	        			<div class="atbd-notice__content">
	        				<div class="atbd-notice__top text-center">
	        					<div class="atbd-notice__icon bg-success">
	        						<i class="fas fa-check color-white"></i>
	        					</div>
	        					<div class="atbd-notice__text">
	        						<h4>완료되었습니다.</h4>
	        					</div>
	        					<div style="display: flex; justify-content: center; margin: 10% auto;">
	        						<a class="btn btn-default btn-success" href="javascript:window.location.reload();" style="color: #FFFFFF;">확인</a>
	        					</div>
	        				</div>
	        			</div>
	        		</div>
	        	</div>
	        </div>
	        <div class="atbd-notice" id="research_success_popup">
	        	<div class="card card-default card-md mb-4">
	        		<div class="card-body">
	        			<div class="atbd-notice__content">
	        				<div class="atbd-notice__top text-center">
	        					<div class="atbd-notice__icon bg-success">
	        						<i class="fas fa-check color-white"></i>
	        					</div>
	        					<div class="atbd-notice__text">
	        						<h4>완료되었습니다.</h4>
	        					</div>
	        					<div style="display: flex; justify-content: center; margin: 10% auto;">
	        						<button class="btn btn-default btn-success" onclick="confirmResearch();" style="color: #FFFFFF;">확인</button>
	        					</div>
	        				</div>
	        			</div>
	        		</div>
	        	</div>
	        </div>
	        <div class="atbd-notice" id="update_popup">
		        	<div class="card card-default card-md mb-4">
		        		<div class="card-body">
		        			<div class="atbd-notice__content">
		        				<div class="atbd-notice__top text-center">
		        					<div class="atbd-notice__icon bg-info">
		        						<i class="fas fa-exclamation color-white"></i>
		        					</div>
		        					<div class="atbd-notice__text">
		        						<h4>수정하시겠습니까?</h4>
		        					</div>
		        					<div style="display: flex; justify-content: center; margin: 10% auto;">
		        						<button class="btn btn-default btn-primary mr-10" onclick="UpdateStep();" style="color: #FFFFFF;">수정</button>
		        						<button class="btn btn-default btn-danger" onclick="CancelBtn();" style="color: #FFFFFF;">취소</button>
		        					</div>
		        				</div>
		        			</div>
		        		</div>
		        	</div>
		        </div>
		        <div class="atbd-notice" id="updateStatus_popup">
		        	<div class="card card-default card-md mb-4">
		        		<div class="card-body">
		        			<div class="atbd-notice__content">
		        				<div class="atbd-notice__top text-center">
		        					<div class="atbd-notice__icon bg-info">
		        						<i class="fas fa-exclamation color-white"></i>
		        					</div>
		        					<div class="atbd-notice__text">
		        						<h4>승인 하시겠습니까?</h4>
		        					</div>
		        					<div style="display: flex; justify-content: center; margin: 10% auto;">
		        						<button class="btn btn-default btn-primary mr-10" onclick="UpdateStatus();" style="color: #FFFFFF;">승인</button>
		        						<button class="btn btn-default btn-danger" onclick="CancelBtn();" style="color: #FFFFFF;">취소</button>
		        					</div>
		        				</div>
		        			</div>
		        		</div>
		        	</div>
		        </div>
		        <div class="atbd-notice" id="delete_popup">
		        	<div class="card card-default card-md mb-4">
		        		<div class="card-body">
		        			<div class="atbd-notice__content">
		        				<div class="atbd-notice__top text-center">
		        					<div class="atbd-notice__icon bg-danger">
		        						<i class="fas fa-exclamation-triangle color-white"></i>
		        					</div>
		        					<div class="atbd-notice__text">
		        						<h4>삭제하시겠습니까?</h4>
		        					</div>
		        					<div style="display: flex; justify-content: center; margin: 10% auto;">
		        						<button class="btn btn-default btn-primary mr-10" onclick="ConfirmDeleteMethod();" style="color: #FFFFFF;">삭제</button>
		        						<button class="btn btn-default btn-danger" onclick="CancelBtn();" style="color: #FFFFFF;">취소</button>
		        					</div>
		        				</div>
		        			</div>
		        		</div>
		        	</div>
		        </div>
	        
	        <div class="modal-basic modal fade show" id="researchAddModal" tabindex="-1" role="dialog" aria-hidden="true">
			    <div class="modal-dialog modal-lg" role="document">
			        <div class="modal-content modal-bg-white">
			        	<div class="modal-header">
			        		<h6 class="modal-title">조사방법 등록</h6>
		                    	<button type="button" class="close" data-dismiss="modal" aria-label="Close">
		                        	<span data-feather="x"></span>
		                        </button>
			        	</div>
			            <div class="modal-body">
			            	<div class="col-12">
			            		<div class="row">
			            			<div class="col-sm-2 d-flex aling-items-center">
		                            	<label for="storage_out_address" class="col-form-label color-dark align-center">조사방법<span style="color: red;">*</span></label>
	                                </div>
	                                <div class="col-sm-10">
		                                <input type="text" class="form-control b-light" id="research_contents">
		                            </div>
			            		</div>
			            		<div class="button-group d-flex justify-content-end mt-2">
				                   <button class="btn btn-primary btn-default btn-squared" onclick="InsertResearch();">추가</button>
				           		</div>
			            	</div>
			            </div>
			        </div>
			    </div>
			</div>
		    <!-- ends: .modal-Basic -->

	        
     	</div>
     </main>
     <!-- 공통 하단 -->
    <th:block th:include="/../fragments/footer.html"></th:block>
    <!-- 공통 js -->
    <th:block th:include="/../fragments/commonjs.html"></th:block>
<script type="text/javascript" th:inline="javascript">

	var method = /*[[${method}]]*/ "null";
	
	var step = /*[[${step}]]*/ "null";
	
	$(function(){
		let w =0;
		
		$(window).resize(function(e){
			w = $(window).width();
			setTimeout(function(){
				if(w < 1365){
					$("#addResearchBtn").text("추가");
					$(".type_1").text("조회");
				} else {
					$("#addResearchBtn").text("조사방법 추가");
					$(".type_1").text("항목조회");
				}
			}, 1);
		});
		$(window).trigger("resize");
		
	});
	
	let selectInputEls = document.querySelectorAll('input[name="select-input"]');
	let select_this;
	let select_prev;
	let select_id;
	
	function selection(){
		if(document.getSelection){
			var selection = document.getSelection();
			
			if(selection.focusNode != null){
				if(selection.focusNode.children != undefined){
					var length = selection.focusNode.children.length;
					if(length != 0){
						var check = selection.focusNode.children[0].name;
						var check2 = selection.focusOffset;
						if(check == "select-input" && check2 == "1"){
							selectFilter(selection.focusNode.children[0]);
						}
					}
				}
			}
			
		}
	}
	
	function selectFilter(e){
		
		var selection = document.getSelection();
		
		select_prev = select_this;
		select_this = e;
		select_id = e.id;
		
		let selectOptionWrapEls = document.querySelectorAll('.select ul');
		
		var currTarget = e;
		var delOption = currTarget.nextElementSibling;
		
		for(var i = 0 ; i < selectOptionWrapEls.length; i++){
			
			if(selectOptionWrapEls[i].classList.contains("select-show")){
				selectOptionWrapEls[i].classList.add('select-hide');
				selectOptionWrapEls[i].classList.remove('select-show');
			}
		}
		
		if(delOption.classList.contains('select-hide')){
			delOption.classList.remove('select-hide');
			delOption.classList.add('select-show');
		}
		
	}
	
	let body = document.querySelector('body');
	function hideSelect(e){
		
		let selectOptionWrapEls = document.querySelectorAll('.select ul');
		var target = e.target.name;
		
		if(target == "select-input"){
			if(select_prev != undefined && select_this != select_prev){
				var prev_attr = select_prev.getAttribute("value");
				var prev_text = select_prev.value;
				if(prev_attr != prev_text){
					select_prev.value = prev_attr;
					var prev_textEl = select_prev.parentNode.children[1].children;
					
					for(var i = 0; i < prev_textEl.length; i++){
						prev_textEl[i].style.display = "flex";
					}
					
					var textEl = select_this.parentNode.children[1].children;
					
					for(var i = 0; i < textEl.length; i++){
						textEl[i].style.display = "flex";
					}
				}
			}
		}
		
		if(target != "select-input"){
			if(select_this != undefined && select_this.value != null){
				var select_attr = select_this.getAttribute("value");
				var select_text = select_this.value;
				
				if(select_attr != select_text && select_this.id == select_id){
					select_this.value = select_attr;
					
					var textEl = select_this.parentNode.children[1].children;
					
					for(var i = 0; i < textEl.length; i++){
						textEl[i].style.display = "flex";
					}
				}
			}
			
			for(var i = 0 ; i < selectOptionWrapEls.length; i++){
				
				if(selectOptionWrapEls[i].classList.contains("select-show")){
					selectOptionWrapEls[i].classList.add('select-hide');
					selectOptionWrapEls[i].classList.remove('select-show');
				}
			}
		}
	}
	body.addEventListener('click',hideSelect);
	body.addEventListener('click', selection);
	
	/* 옵션선택 */
	function selectOpt(e){
	    var dataSelect = $(e).children().attr("data-value");
	    var text = $(e).children().text();
	    $(e).parent().prev().attr("data-select", dataSelect);
	    $(e).parent().prev().attr("value", text);
	    $(e).parent().attr("class", "select-hide");
	    
	    var current_this = e.parentNode.previousElementSibling;
	    var current_this_id = current_this.id;
	    
	    //입력 단위 이벤트
	    if(current_this_id == "method_input"){
	    	var method_input = dataSelect;
	    	
	    	var data = {"eaches_type" : method_input};
	    	
	    	$.ajax(
   			{
   				url : 'selectEaches',
   				method : 'POST',
   				dataType : 'json',
   				data : data,
   				success : function(result)
   				{
   					
   					var method_eaches = $("#method_eaches").next();
   					var add_list = "";
   					
   					
   					$("#method_eaches").attr("data-select", "");
   					$("#method_eaches").attr("value", "");
					$("#method_eaches").val("");
   					
   					for(var i = 0; i < result.length; i++)
   					{
   						add_list += '<li class="method_input_list" onclick="selectOpt(this);">';
   						add_list += '<span data-value="'+result[i].eaches_id+'">'+result[i].eaches_name+'</span>';
   						add_list += '</li>';
   					}  
   					
   					method_eaches.empty();
   					method_eaches.append(add_list);
   				}
   			});
	    }
		
	    //조사 항목 이벤트
	    if(current_this_id == "division_depth1" || current_this_id == "division_depth2" || current_this_id == "division_depth3"){
	    	var division_id = dataSelect;
	    	var division_depth = current_this_id.slice(14, 15);
	    	
	    	var data = {"division_id" : division_id, "division_depth" : division_depth};
	    	
	    	$.ajax(
   			{
   				url : 'selectDivision',
   				method : 'POST',
   				dataType : 'json',
   				data : data,
   				success : function(result)
   				{
   					var depth = (division_depth * 1) + 1;
   					var depth_list = $("#division_depth" + depth).next();
   					var add_list = "";
   					
   					if(division_depth == "1"){
   						$("#division_depth2").attr("data-select", "");
   						$("#division_depth2").attr("value", "");
       					$("#division_depth2").val("");
       					
       					$("#division_depth3").attr("data-select", "");
       					$("#division_depth3").attr("value", "");
       					$("#division_depth3").val("");
   					}else if(division_depth == "2"){
   						$("#division_depth3").attr("data-select", "");
   						$("#division_depth3").attr("value", "");
       					$("#division_depth3").val("");
   					}
   					
   					for(var i = 0; i < result.length; i++)
   					{
   						add_list += '<li class="division_depth'+depth+'_list" onclick="selectOpt(this);">';
   						add_list += '<span data-value="'+result[i].division_id+'">'+result[i].division+'</span>';
   						add_list += '</li>';
   					}
   					
   					depth_list.empty();
   					depth_list.append(add_list);
   				}
   			});
	    }
		
	    
	}//end 옵션 선택
	
	//필터 함수
	function textfilter(e){
		
		var search = $(e).val().toLowerCase();
		var className = $(e).next().children().eq(0).attr('class');
		
		$(document).find("."+className).each(function(index, item){
			var text = $(this).children().text();
			
			if(text.toLowerCase().includes(search)){
				$(this).css("display", "flex");
			}else{
				$(this).css("display", "none");
			}
		});
		
	}//end 필터 함수
	
	function loadSelectData(){
		//입력 단위 selected 이벤트
		$("#method_input").attr("data-select", method.method_input);
		$("#method_input").attr("value", method.method_input);
		
		var data = {"eaches_type" : method.method_input};
    	
    	$.ajax(
			{
				url : 'selectEaches',
				method : 'POST',
				dataType : 'json',
				data : data,
				success : function(result)
				{
					
					var method_eaches = $("#method_eaches").next();
					var add_list = "";
					
					for(var i = 0; i < result.length; i++)
					{
						add_list += '<li class="method_input_list" onclick="selectOpt(this);">';
						add_list += '<span data-value="'+result[i].eaches_id+'">'+result[i].eaches_name+'</span>';
						add_list += '</li>';
					}
					
					method_eaches.empty();
					method_eaches.append(add_list);
					
					$("#method_eaches").attr("data-select", method.eaches_id);
					$("#method_eaches").attr("value", method.eaches_name);
				}
			});
    	
    	//조사항목 기존 데이터
    	$("#division_depth1").attr("data-select", method.d1_id);
		$("#division_depth1").attr("value", method.d1_name);
		
		$("#division_depth2").attr("data-select", method.d2_id);
		$("#division_depth2").attr("value", method.d2_name);
		
		$("#division_depth3").attr("data-select", method.d3_id);
		$("#division_depth3").attr("value", method.d3_name);
		
		
	}
	loadSelectData();
	
	//method 명 초기 입력 이벤트
	(function(){
		
		var d1 = $("#division_depth1").attr("data-select");
		var d2 = $("#division_depth2").attr("data-select");
		var d3 = $("#division_depth3").attr("data-select");
		var d1_text = $("#division_depth1").attr("value");
		var d2_text = $("#division_depth2").attr("value");
		var d3_text = $("#division_depth3").attr("value");
		
		var method_title = method.method_title;
		$("#input_title").attr("value", d1_text + " > " + d2_text + " > " +  d3_text + " > " +  method_title);
		
		var data = {"division_id" : method.d3_id};
		
		$.ajax(
		{
			url : 'selectResearch',
			method : 'POST',
			dataType : 'json',
			data : data,
			success : function(result)
			{
				var research_list = $("#research_list");
				var add_list = "";
				
				for(var i = 0; i < result.length; i++)
				{
					add_list += '<li class="check_research_list list-group-item step-list">';
					add_list += '<input type="checkbox" class="checkbox mr-2" name="chk_research" value="' + result[i].research_id + '">';
					add_list += '<span>'+ result[i].research_contents + '</span>';
					add_list += '</li>';
				}
				
				research_list.empty();
				research_list.append(add_list);
				
				

				setTimeout(function(){
					
					$( ".check_research_list" ).click(function(e) {

						if(e.target.tagName != "input" && e.target.tagName != "INPUT")
							this.children[0].checked = this.children[0].checked == true ? false : true;
					});
					
				},500);
				
			}
		});
		
	})();//end method 명 초기 입력 이벤트
	
	//step 초기 그려주기 이벤트
	(function(){
		var step_container = $("#step-container");
		var length = step.length;
		
		var add_list = "";
		
		for(var i = 0; i < step.length; i++){
			add_list += '<div th:data-id='+step[i].research_id+' class="list-group step">';
			add_list += '<li class="list-group-item-sm list-group-item">';
			add_list += '<div class="row">';
			
			add_list += '<div class="mb-1 col-2">';
			add_list += '<input type="checkbox" class="checkbox mr-2" name="mis_research">';
			add_list += '<span class="step-text">step ' + step[i].step_index + '</span>';
			add_list += '</div>';
			
			add_list += '<div class="mb-1 col-6">';
			add_list += '<span class="research-title">'+step[i].research_contents+'</span>';
			add_list += '</div>';
			
			add_list += '<div class="mb-1 col-4">';
			add_list += '<textarea rows="2" class="form-control step_comment" placeholder="comment">';
			add_list += step[i].step_comment;
			add_list += '</textarea>';
			add_list += '</div>';
				
			add_list += '</div>';
			add_list += '</li>';
			add_list += '</div>';
		}//end for
		
		step_container.append(add_list);
		inputProtocol();
	})();//end step 초기 그려주기 이벤트
	
	//메소드 공유 초기 선택 이벤트
	if(method.method_share == "1"){
		$("#method_share").prop("checked", true);
		$("#method_share").val(1);
	}
	
	// step data array
	var dataArr = new Array();
	
	// 항목 조회 Modal
	function DivisionBtn()
	{
		$("#divisionModal").modal("show");
		
		$("#titleBtn").prop("disabled", true);
	}
	
	// method명 사용 버튼 활성화
	$("#method_title").keyup(function()
	{
		var d3 = $("#division_depth3").attr("data-select");
		
		if(d3 != "")
		{
			$("#titleBtn").prop("disabled", false);
		}
	});
	
	// method명 사용
	function TitleBtn()
	{
		var d1 = $("#division_depth1").attr("data-select");
		var d2 = $("#division_depth2").attr("data-select");
		var d3 = $("#division_depth3").attr("data-select");
		var d1_text = $("#division_depth1").attr("value");
		var d2_text = $("#division_depth2").attr("value");
		var d3_text = $("#division_depth3").attr("value");
		
		var method_title = $("#method_title").val();
		
		var data = {"division_id" : d3};
		
		$.ajax(
		{
			url : 'selectResearch',
			method : 'POST',
			dataType : 'json',
			data : data,
			success : function(result)
			{
				var research_list = $("#research_list");
				var add_list = "";
				
				for(var i = 0; i < result.length; i++)
				{
					add_list += '<li class="list-group-item step-list" style="width: 355px;">';
					add_list += '<input type="checkbox" class="checkbox mr-2" name="chk_research" value="' + result[i].research_id + '">';
					add_list += '<span>'+ result[i].research_contents + '</span>';
					add_list += '</li>';
				}
				
				research_list.empty();
				research_list.append(add_list);
				
				$("#input_title").attr("value", d1_text + " > " + d2_text + " > " +  d3_text + " > " +  method_title);
				
				$("#divisionModal").modal("hide");
			}
		});
	}
	
	function InsertPopup()
	{
		$("#researchAddModal").modal("show");
	}
	
	//조사방법 체크박스 추가
	function PlusResearch()
	{
		var step_container = $("#step-container");
		var length = $("#step-container").children().length;
		
		var add_list = "";
		
		
		$(document).find("input:checkbox[name=chk_research]:checked").each(function()
		{
			var research_id = $(this).val();
			var research_title = $(this).next().text();
			
			if(length == 0){
				length = 1;
			}else {
				length++;
			}
			
			/* console.log(research_id);
			console.log(research_title); */
			
			add_list += '<div th:data-id='+research_id+' class="list-group step">';
			add_list += '<li class="list-group-item-sm list-group-item">';
			add_list += '<div class="row">';
			
			add_list += '<div class="mb-1 col-2">';
			add_list += '<input type="checkbox" class="checkbox mr-2" name="mis_research">';
			add_list += '<span class="step-text">step ' + length + '</span>';
			add_list += '</div>';
			
			add_list += '<div class="mb-1 col-6">';
			add_list += '<span class="research-title">'+research_title+'</span>';
			add_list += '</div>';
			
			add_list += '<div class="mb-1 col-4">';
			add_list += '<textarea rows="2" class="form-control step_comment" placeholder="comment">';
			add_list += '</textarea>';
			add_list += '</div>';
				
			add_list += '</div>';
			add_list += '</li>';
			add_list += '</div>';
			
		});
		
		step_container.append(add_list);
		inputProtocol();
	}//end 조사방법 체크박스 추가
	
	//조사방법 체크박스 삭제
	function MinusResearch()
	{
		
		var step_container = $("#step-container");
		var add_list = "";
		
		//체크박스 삭제
		$(document).find("input:checkbox[name=mis_research]:checked").each(function()
		{	
			var del_div = $(this).parent().parent().parent().parent();
			del_div.remove();
		});
		
		//삭제 후 step 번호 수정
		var length = 1;
		$(document).find(".step-text").each(function()
		{
			$(this).text("step " + length++);
		});
		inputProtocol();
	}//end 조사방법 체크박스 삭제
	
	// 조사방법 등록
	function InsertResearch()
	{
		var division_id = $("#division_depth3").attr("data-select");
		var research_contents = $("#research_contents").val();
		
		if(division_id == "")
		{
			alert("조사 항목을 선택하세요.");
		}
		else if(research_contents == "")
		{
			alert("조사 방법을 입력하세요.");
		}
		else
		{
			var data = {"division_id" : division_id, "research_contents" : research_contents};
			
			$.ajax(
			{
				url : '/method/insertResearch',
				method : 'POST',
				dataType : 'json',
				data : data,
				success : function(result)
				{
					if(result == 0)
					{
						
					}
					else
					{
						$("#researchAddModal").modal("hide");
						$("#research_contents").val('');
						$("#research_success_popup").css("display", "flex");
					}
				}
			});
			
		}
		
	}//end 조사방법 등록
	
	//조사방법 등록 후 완료 팝업 닫기
	function confirmResearch(){
		TitleBtn();//조사방법 등록 완료 후 조사방법 테이블 다시 만들어주기
		$("#research_success_popup").css("display", "none");
	}
	
	//프로토콜 등록 버튼 함수
	function UpdateStep(){
		
		//메소드 등록 후 실행 함수
		getUpdateMethod().then(function(result){
			
			if(result == 0){
				alert("프로토콜 수정이 실패했습니다. 다시수정해 주세요.");
			}else{
				
				getDeleteStep().then(function(result){
					
					var method_id = method.method_id;
					
					//선택한 step
					$(document).find(".step").each(function(index, item){
						var step_index = $(this).find(".step-text").text().split(" ");
						console.log(step_index);
						var data = {
								"method_id" : method_id,
								"research_id" : $(this).attr("th:data-id"),
								"step_index" : step_index[1],
								"step_comment" : $(this).find(".step_comment").val(),
								};
						dataArr.push(data);
					});
					console.log(dataArr);
					
					$.ajax({
						url : "/method/insertStep",
						method : "POST",
						contentType : "application/json; charset=utf-8",
						data : JSON.stringify(dataArr),
						success : function(result){
							
							if(result == 0){
								
							}else {
								$("#update_popup").css("display", "none");
								$("#success_popup").css("display", "flex");
							}
						}
					});//end ajax
					
				});//end deleteStep.then()
				
			}//end else
			
		});//end getUpdateMethod().then
		
	}//end UpdateStep
	
	function deleteStep(){
		return new Promise(function(resolve){
			var cancelArr = new Array();
			for(var i = 0; i < step.length; i++){
				cancelArr.push(step[i].step_id);
			}
			
			$.ajax(
			{
				url : "/method/deleteStep?cancelArr="+cancelArr,
				method : "POST",
				success : function(result){
					resolve(result);
				}//end success
				
			});//end ajax
			
		});
	}//end deleteStep
	
	//메소드 공유 체크박스 이벤트
	$(document).on("change", "#method_share", function(){
		if($(this).is(':checked')){
			$(this).val(1);
		}else{
			$(this).val(0);
		}
	});
	
	//프로토콜 Update 함수
	function UpdateMethod(){
		return new Promise(function(resolve){
			
			var method_id = method.method_id;
			var method_title = $("#method_title").val();
			var method_contents = $("#method_contents").val();
			var method_input = $("#method_input").attr("data-select");
			var eaches_id = $("#method_eaches").attr("data-select");
			var method_comment = $("#method_comment").val();
			var method_code = method.method_code;
			var method_share = $("#method_share").val();
			
			if(method_title == "")
			{
				alert("method 명을 선택해주세요.");
				$("#input_title").focus();
			}
			else if(method_input == "")
			{
				alert("입력단위를 선택해주세요");
				$("#method_input").focus();
			}
			else if(eaches_id == "")
			{
				alert("단위 종류를 선택해주세요");
				$("#method_eaches").focus();
			}
			else
			{
				var data = {
						"method_id" : method_id,
						"method_title" : method_title,
						"method_contents" : method_contents,
						"method_input" : method_input,
						"eaches_id" : eaches_id,
						"method_comment" : method_comment,
						"method_code" : method_code,
						"method_share" : method_share
				};
				/* console.log(data); */
				$.ajax(
				{
					url : "/method/updateMethod",
					method : "POST",
					dataType : 'json',
					data : data,
					success : function(result){
						resolve(result);
					}//end success
					
				});//end ajax
				
			}//end else
			
		});//end return
	}//end insertMethod
	
	//재배 프로토콜 삭제 함수
	function DeleteMethod(){
		return new Promise(function(resolve){
			
			var data = {"method_id" : method.method_id};
			
			$.ajax(
			{
				url : "/method/deleteMethod",
				method : "POST",
				dataType : 'json',
				data : data,
				success : function(result){
					resolve(result);
				}//end success
				
			});//end ajax
		});
	}//end 재배 프로토콜 삭제 함수
	
	function ConfirmDeleteMethod(){
		DeleteMethod().then(function(result){
			if(result == 0){
				alert("프로토콜 삭제가 실패했습니다. 다시수정해 주세요.");
			}else{
				getDeleteStep().then(function(result){
					if(result == 0){
						
					}else {
						$("#delete_popup").css("display", "none");
						$("#success_popup").css("display", "flex");
					}
				});//end getDeleteStep
				
			}//end else
				
		});//end DeleteMethod
		
	}//end confiemdeletemethod
	
	//재배 프로토콜 ajax 통신 완료 후 진행하는 함수
	async function getUpdateMethod(){
		var result = await UpdateMethod();
		return result;
	}
	
	async function getDeleteStep(){
		var result = await deleteStep();
		return result;
	}
	
	//프로토콜 step 선택여부에 따라 protocol textarea 값 넣어주는 함수
	function inputProtocol(){
		
		var protocol = $("#protocol");
		var add_list = "";
		
		$(document).find(".step").each(function(index, item){
			var step = $(this).find(".step-text").text();
			var research_title = $(this).find(".research-title").text();
			
			add_list += step + " : " + research_title + "\n";
			
		});
		
		/* protocol.val(add_list);
		$("#protocol").attr('value', add_list); */
		var protocolEl = document.querySelector('#protocol');
		
		protocolEl.innerHTML = add_list;
	}
	
	//jquery sortable 적용	
	$(document).find("#step-container").sortable({
		placeholder : "itemBoxHighlight",
		start : function(event, ui){
			
		},
		stop : function(event, ui){
			reorder();
			inputProtocol();
		}
	});//end sortable
	
	//번호 재입력
	function reorder(){
		$(document).find(".step").each(function(i, item){
			$(this).find(".step-text").text("step " + (i+1));
		});
	}
	
	//
	function UpdateBtn(){
		$("#update_popup").css("display", "flex");
	}
	
	//삭제 버튼 안내 팝업
	function DeleteBtn() {
		$("#delete_popup").css("display", "flex");
	}
	//팝업 취소
	function CancelBtn() {
		$("#update_popup").css("display", "none");
		$("#delete_popup").css("display", "none");
	}
	
	//승인 버튼 안내 팝업
	function UpdateStatusBtn(){
		$("#updateStatus_popup").css("display", "flex");
	}
	
	//조사방법 검색 함수
	function filter(){
		var search = $("#searchResearch").val().toLowerCase();
		var list = $(".step-list");
		
		$(document).find(".step-list").each(function(i, item){
			var text = $(this).children(":last").text();
			
			if(text.toLowerCase().includes(search)){
				$(this).css("display", "flex");
			}else{
				$(this).css("display", "none");
			}
		});
		
	}//end 조사방법 검색
	
	//승인 함수
	function UpdateStatus(){
		
		var data = {"method_id" : method.method_id, "method_code" : method.method_code};
		
		$.ajax(
		{
			url : "/method/updateStatus",
			method : "POST",
			dataType : 'json',
			data : data,
			success : function(result){
				if(resut = 0){
					
				}else {
					$("#updateStatus_popup").css("display", "none");
					$("#success_popup").css("display", "flex");
				}
			}//end success
			
		});//end ajax
		
	}//end 승인 함수
	
	//인쇄 이벤트
	$("#printBtn").on("click", function(){
		var initBody;
		
		//인쇄 전 실행 함수
		window.onbeforeprint = function(){
			document.body.innerHTML = document.getElementById('printDiv').innerHTML;
		};
		
		//인쇄 후 실행 함수
		window.onafterprint = function(){
			/* document.body.innerHTML = initBody; */
			this.window.location.reload();// 인쇄 후 화면 리로드
		};
		
		window.print();//인쇄 실행
	});
	
</script>
</body>
</html>