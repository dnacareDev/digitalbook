<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.digitalBook.Mapper.HomeMapper">
	<!-- 지난 일정 조회 -->
	<select id="selectDelayPlanList" parameterType="int" resultType="Plan">
		SELECT p.*, r.*, s.*, m.*, sc.*, u.*
		FROM plan p
		LEFT JOIN report r ON p.report_code = r.report_code
		LEFT JOIN storage s ON p.storage_id = s.storage_id
		LEFT JOIN method m ON p.plan_method = m.method_id
		LEFT JOIN (select * from schedule where end_date  <![CDATA[<]]>  date(now())) sc ON p.plan_id = sc.plan_id
		LEFT JOIN user u ON sc.sch_supervisor = u.user_id
		WHERE p.user_group = #{user_group} AND sc.sch_supervisor = #{user_id} OR sch_manager = #{user_id}
		GROUP BY p.plan_id
		ORDER BY p.plan_id DESC
	</select>
	
	<!-- 진행일정 조회 -->
	<select id="selectCurrentPlanList" parameterType="int" resultType="Plan">
		SELECT p.*, r.*, s.*, m.*, sc.*, u.*
		FROM plan p
		LEFT JOIN report r ON p.report_code = r.report_code
		LEFT JOIN storage s ON p.storage_id = s.storage_id
		LEFT JOIN method m ON p.plan_method = m.method_id
		LEFT JOIN (select * from schedule where end_date  <![CDATA[>]]>  date(now())) sc ON p.plan_id = sc.plan_id
		LEFT JOIN user u ON sc.sch_supervisor = u.user_id
		WHERE p.user_group = #{user_group} AND sc.sch_supervisor = #{user_id} OR sch_manager = #{user_id}
		GROUP BY p.plan_id
		ORDER BY p.plan_id DESC
	</select>
	
	<select id="selectProgressPlanList" resultType="Plan">
		SELECT p.*, r.*, s.*, m.*, sc.*, u.*
		FROM plan p
		LEFT JOIN report r ON p.report_code = r.report_code
		LEFT JOIN storage s ON p.storage_id = s.storage_id
		LEFT JOIN method m ON p.plan_method = m.method_id
		LEFT JOIN schedule sc ON p.plan_id = sc.plan_id
		LEFT JOIN user u ON sc.sch_supervisor = u.user_id
		WHERE p.user_group = #{user_group} AND sc.sch_supervisor = #{user_id} OR sch_manager = #{user_id}
		GROUP BY p.plan_id
		ORDER BY p.plan_id DESC
	</select>
	
	<!-- 전체 일정(사용자) -->
	<select id="SelectUserSchedule" parameterType="int" resultType="Schedule">
		SELECT s.sch_id, s.start_date, s.end_date, p.plan_id, p.plan_code, m.method_id, m.method_code, m.method_title, u1.user_name_k AS u1_supervisor, u2.user_name_k AS u2_manager
		FROM schedule s
		LEFT JOIN plan p ON s.plan_id = p.plan_id
		LEFT JOIN method m ON s.method_id = m.method_id
		LEFT JOIN user u1 ON s.sch_supervisor = u1.user_id
		LEFT JOIN user u2 ON s.sch_manager = u2.user_id
		WHERE s.sch_supervisor = #{user_id} OR s.sch_manager = #{user_id}
	</select>
</mapper>